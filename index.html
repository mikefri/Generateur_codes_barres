<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur Code 128 • EAN-13 • QR Code</title>
  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root { --bg:#1e1e2e; --card:#2d2d44; --text:#cdd6f4; --accent:#89b4fa; }
    @media (prefers-color-scheme: light) { :root { --bg:#f8f9fa; --card:white; --text:#333; --accent:#0d6efd; } }
    body { font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; }
    .container { max-width:800px; width:100%; }
    h1 { color:var(--accent); text-align:center; margin:10px 0 5px; }
    .card { background:var(--card); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.3); margin-bottom:20px; }
    input, select, button { padding:12px 16px; margin:8px; border-radius:8px; font-size:16px; }
    input, select { background:#333; color:white; border:2px solid #444; width:100%; max-width:500px; }
    button { background:var(--accent); color:white; border:none; cursor:pointer; font-weight:bold; }
    button:hover { opacity:.9; }
    .actions { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:15px; }
    .barcode-container { background:white; padding:40px; border-radius:12px; text-align:center; }
    canvas, svg { max-width:100%; height:auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Générateur Universel</h1>
    <p>Code 128 • EAN-13 • QR Code</p>

    <div class="card">
      <input type="text" id="texte" placeholder="Texte, URL ou numéro" value="1234567890" autofocus>

      <select id="type">
        <option value="CODE128">Code 128</option>
        <option value="EAN13">EAN-13</option>
        <option value="QRCODE">QR Code</option>
      </select>

      <div class="actions">
        <button onclick="generer()">Générer</button>
        <button onclick="telecharger()">Télécharger PNG</button>
        <button onclick="copier()">Copier</button>
        <button onclick="imprimer()">Imprimer</button>
      </div>
    </div>

    <div class="barcode-container" id="capture">
      <div id="result"></div>
    </div>
  </div>

  <script>
    function generer() {
      const texte = document.getElementById("texte").value.trim();
      const type = document.getElementById("type").value;
      const result = document.getElementById("result");
      result.innerHTML = "";   // vide le conteneur

      if (!texte && type !== "QRCODE") {
        result.innerHTML = "<p style='color:red'>Entre du texte !</p>";
        return;
      }

      if (type === "CODE128") {
        const svg = document.createElement("svg");
        result.appendChild(svg);
        JsBarcode(svg, texte, {
          format: "CODE128",
          displayValue: true,
          height: 100,
          fontSize: 20,
          margin: 30
        });

      } else if (type === "EAN13") {
        let num = texte.replace(/\D/g, "").substring(0, 12);
        if (num.length === 12) num += calculCheckDigit(num);
        if (num.length !== 13) {
          result.innerHTML = "<p style='color:red'>EAN-13 : 12 ou 13 chiffres requis</p>";
          return;
        }
        const svg = document.createElement("svg");
        result.appendChild(svg);
        JsBarcode(svg, num, {
          format: "EAN13",
          displayValue: true,
          height: 120,
          fontSize: 22,
          margin: 30
        });

      } else if (type === "QRCODE") {
        const canvas = document.createElement("canvas");
        result.appendChild(canvas);
        QRCode.toCanvas(canvas, texte || "https://github.com", {
          width: 300,
          margin: 2
        });
      }
    }

    function calculCheckDigit(ean12) {
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += (i % 2 === 0 ? 1 : 3) * parseInt(ean12[i]);
      }
      return (10 - (sum % 10)) % 10;
    }

    function telecharger() {
      html2canvas(document.getElementById("capture"), {scale: 3}).then(canvas => {
        const a = document.createElement("a");
        a.download = "barcode.png";
        a.href = canvas.toDataURL();
        a.click();
      });
    }

    function copier() {
      html2canvas(document.getElementById("capture"), {scale: 2}).then(canvas => {
        canvas.toBlob(blob => {
          navigator.clipboard.write([new ClipboardItem({ "image/png": blob })])
            .then(() => alert("Copié dans le presse-papier !"))
            .catch(() => alert("Erreur de copie"));
        });
      });
    }

    function imprimer() {
      const content = document.getElementById("result").innerHTML;
      const win = window.open("", "_blank");
      win.document.write(`
        <!DOCTYPE html>
        <html><head><title>Impression</title>
        <style>
          body{margin:0;padding:20mm;background:white;display:flex;justify-content:center;align-items:center;height:100vh;}
          canvas,svg{max-width:100%;height:auto;}
          @media print{@page{margin:5mm;}body{padding:0;}}
        </style></head>
        <body>${content}
          <script>window.print();window.onafterprint=()=>window.close();<\/script>
        </body>
        </html>
      `);
      win.document.close();
    }

    // Lancement automatique
    generer();
    document.getElementById("texte").addEventListener("input", generer);
    document.getElementById("type").addEventListener("change", generer);
  </script>
</body>
</html>
